# diagnosis/logic.py
# 役割：スコアからレベル判定し、診断メッセージを組み立てる

import random

# =========================
# 固定の「止め文」
# =========================
STOP_MESSAGE = (
    "ここから先は、\n"
    "決まった文章ではうまくお返しできません。\n\n"
    "感じている思いは同じかもしれませんが、\n"
    "それをどう言葉にするかは人それぞれだからです。\n\n"
    "もし今、あなたの言葉で少しだけ書けることがあるなら、\n"
    "必要な方にだけ、1通のみメールで言葉を送ることができます。\n"
    "（送らなくても、診断はここで完了です）"
)

# =========================
# メッセージ素材
# =========================
MESSAGES = {
    "light": {
        "observation": [
            "今回の回答からは、判断の舵を内側に戻す力がすでにある様子が見えます。",
            "他人の影響を受けつつも、自分の感覚を完全には失っていない状態です。"
        ],
        "mirror": [
            "ただ、忙しさや緊張が続くと、外側に引っ張られやすい場面もありそうです。",
            "無意識のうちに「合わせる選択」が増えていないでしょうか。"
        ],
        "question": [
            "最近、自分の感覚を優先できた場面はありましたか？",
            "そのとき、何が支えになっていましたか？"
        ]
    },

    "middle": {
        "observation": [
            "今回の回答は、自分軸と他人軸が場面によって入れ替わる傾向を示しています。",
            "普段は保てていても、負荷がかかると外側に寄りやすい状態です。"
        ],
        "mirror": [
            "期待に応えようとする気持ちが、判断の前に立つことがありそうです。",
            "「正解探し」が増えるほど、決断が重くなっていないでしょうか。"
        ],
        "question": [
            "外側に寄り始める合図は、あなたの場合どれでしょうか？",
            "最近、自分の感覚を後回しにした回数は増えていますか？"
        ]
    },

    "strong": {
        "observation": [
            "今回の回答からは、判断の舵が外側に置かれている時間が長い傾向が見えます。",
            "自分で選んでいるつもりでも、反応に引っ張られやすい状態かもしれません。"
        ],
        "mirror": [
            "周囲を優先することで、自分を守ってきた時間が長かった可能性があります。",
            "「もし誰にも迷惑をかけなくていいとしたら」という問いが浮かびにくい状態です。"
        ],
        "question": [
            "あなたの判断は、普段どこから許可を得ていますか？",
            "反応が消えたら、選択はどこが変わりそうでしょうか？"
        ]
    }
}

# =========================
# レベル判定
# =========================
def get_level(score):
    if score >= 22:
        return "strong"
    elif score >= 14:
        return "middle"
    else:
        return "light"

# =========================
# 診断メッセージ生成
# =========================
def build_message(score):
    level = get_level(score)
    data = MESSAGES[level]

    return {
        "level": level,
        "observation": random.choice(data["observation"]),
        "mirror": random.choice(data["mirror"]),
        "question": random.choice(data["question"]),
        "stop": STOP_MESSAGE
    }
